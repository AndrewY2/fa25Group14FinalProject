@model fa25Group14FinalProject.Models.Order
@using System.Linq
@using fa25Group14FinalProject.Models

@{
    ViewData["Title"] = "Shopping Cart";

    var potentialSavingsList = ViewBag.PotentialSavings as List<dynamic> ?? new List<dynamic>();

    var freeShippingCoupon = potentialSavingsList
                                .FirstOrDefault(p => p.Type == "FreeShipping" && p.Savings > 0);

    // All coupon codes (percent OR free-ship) that actually save money
    var allCouponCodes = potentialSavingsList
        .Where(p => p.Savings > 0)
        .Select(p => (string)p.Code)
        .Distinct()
        .ToList();
}

<h1>üõçÔ∏è Your Shopping Cart</h1>
<hr />

@if (TempData["CartRemovalMessages"] is List<string> removalMessages && removalMessages.Any())
{
    <div class="alert alert-warning">
        <p><strong>Heads Up! The following items were updated/removed:</strong></p>
        <ul>
            @foreach (var message in removalMessages)
            {
                <li>@message</li>
            }
        </ul>
    </div>
}

@if (TempData["CartDiscountMessages"] is List<string> discountMessages && discountMessages.Any())
{
    <div class="alert alert-success">
        <p><strong>üéâ Discount applied!</strong></p>
        <ul>
            @foreach (var msg in discountMessages)
            {
                <li>@msg</li>
            }
        </ul>
    </div>
}

@if (TempData["ErrorMessage"] != null)
{
    <div class="alert alert-danger">@TempData["ErrorMessage"]</div>
}

<div asp-validation-summary="ModelOnly" class="text-danger"></div>

@if (!Model.OrderDetails.Any())
{
    <p class="lead">Your shopping cart is currently empty. Start browsing our books!</p>
    <a asp-controller="Books" asp-action="Search" class="btn btn-primary">Go to Books</a>
}
else
{
    <div class="row">
        <div class="col-12">
            @{
                var totalQty = Model.OrderDetails.Sum(od => od.Quantity);
                var label = totalQty == 1 ? "Book" : "Books";
            }

            <h3>Cart Contents (@totalQty @label)</h3>


            <table class="table table-striped">
                <thead>
                    <tr>
                        <th style="width: 40%;">Book</th>
                        <th style="width: 15%;">Price</th>
                        <th style="width: 20%;">Qty</th>
                        <th style="width: 15%;">Extended Price</th>
                        <th style="width: 10%;"></th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var od in Model.OrderDetails)
                    {
                        <tr>
                            <td>@od.Book.Title</td>
                            <td>@od.Price.ToString("C")</td>

                            <td>
                                <form asp-action="Edit"
                                      asp-controller="OrderDetails"
                                      method="post"
                                      class="form-inline">
                                    <input type="hidden" name="id" value="@od.OrderDetailID" />
                                    <input type="number"
                                           name="Quantity"
                                           value="@od.Quantity"
                                           min="0"
                                           max="@od.Book.InventoryQuantity"
                                           class="form-control form-control-sm w-50 mr-2" />
                                    <input type="submit"
                                           value="Update"
                                           class="btn btn-sm btn-info" />
                                </form>
                            </td>

                            <td>@od.ExtendedPrice.ToString("C")</td>

                            <td>
                                <form asp-action="Delete"
                                      asp-controller="OrderDetails"
                                      method="post"
                                      class="d-inline">
                                    <input type="hidden" name="id" value="@od.OrderDetailID" />
                                    <input type="submit"
                                           value="X"
                                           class="btn btn-sm btn-danger"
                                           title="Remove Item" />
                                </form>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>

            @* Simple text note about available coupon codes (percent OR free-ship) *@
            @if (allCouponCodes.Any())
            {
                <div class="alert alert-info">
                    <p>
                        Apply one of the following coupon codes at checkout:
                        <br />
                        <strong>@string.Join(", ", allCouponCodes)</strong>
                    </p>
                </div>
            }
        </div>
    </div>

    <hr class="mt-4 mb-4" />

    <div class="row">
        <div class="col-12 col-md-6 offset-md-6 col-lg-4 offset-lg-8">
            <h3>Summary</h3>

            <table class="table table-sm">
                <tr>
                    <th class="text-right">Subtotal:</th>
                    <td>@Model.Subtotal.ToString("C")</td>
                </tr>
                <tr>
                    <th class="text-right">Original Shipping Fee:</th>
                    <td>@ViewBag.CurrentShippingFee.ToString("C")</td>
                </tr>

                @if (freeShippingCoupon != null)
                {
                    <tr>
                        <th class="text-right text-danger">
                            Shipping with @freeShippingCoupon.Code:
                        </th>
                        <td><strong class="text-danger">$0.00</strong></td>
                    </tr>
                }

                <tr>
                    <th class="text-right">Current Order Total:</th>
                    <td class="font-weight-bold">@ViewBag.CurrentOrderTotal.ToString("C")</td>
                </tr>

                @if (potentialSavingsList.Any(p => p.PotentialTotal < ViewBag.CurrentOrderTotal))
                {
                    decimal lowestPotentialTotal = potentialSavingsList.Min(p => (decimal)p.PotentialTotal);
                    var lowestCoupon = potentialSavingsList.First(p => p.PotentialTotal == lowestPotentialTotal);

                    <tr>
                        <th class="text-right text-success">
                            Lowest Potential Total (Coupon @lowestCoupon.Code):
                        </th>
                        <td><strong class="text-success">@lowestPotentialTotal.ToString("C")</strong></td>
                    </tr>
                }
            </table>

            @if (potentialSavingsList.Count > 0)
            {
                <h4 class="mt-4">üí∞ All Potential Coupon Total Previews</h4>
                <ul class="list-group">
                    @foreach (var potential in potentialSavingsList)
                    {
                        <li class="list-group-item list-group-item-light d-flex justify-content-between align-items-center">
                            <div>@potential.Code total:</div>
                            <div><strong class="text-success">@potential.PotentialTotal.ToString("C")</strong></div>
                        </li>
                    }
                </ul>
            }

            <br />

            <a asp-controller="Orders"
               asp-action="Checkout"
               class="btn btn-warning btn-lg btn-block">
                Proceed to Checkout
            </a>
        </div>
    </div>
}
