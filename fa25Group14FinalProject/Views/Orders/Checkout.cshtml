@model fa25Group14FinalProject.Models.Order
@using Microsoft.AspNetCore.Mvc.Rendering

@{
    ViewData["Title"] = "Checkout";
    var cards = ViewBag.AllCards as SelectList;
}

<h2>Checkout</h2>
<hr />

<div asp-validation-summary="ModelOnly" class="text-danger"></div>

@if (TempData["ErrorMessage"] != null)
{
    <div class="alert alert-danger">
        @TempData["ErrorMessage"]
    </div>
}

@if (Model == null || Model.OrderDetails == null || !Model.OrderDetails.Any())
{
    <div class="alert alert-info">
        Your cart is empty. Please add some books before checking out.
    </div>

    <a asp-controller="Books" asp-action="Search" class="btn btn-primary">
        Back to Book Search
    </a>
}
else
{
    <div class="row">
        <!-- LEFT SIDE: Payment + Coupon -->
        <div class="col-md-5">
            <h4>Payment & Promotions</h4>
            <hr />

            @using (Html.BeginForm("PlaceOrder", "Orders", FormMethod.Post))
            {
                @Html.AntiForgeryToken()

                @* card selection posts as SelectedCardID to match action signature *@
                <div class="form-group">
                    <label for="SelectedCardID">Select a Card</label>
                    <select id="SelectedCardID"
                            name="SelectedCardID"
                            class="form-control"
                            asp-items="cards">
                        <option value="">-- Select a card --</option>
                    </select>
                    @Html.ValidationMessage("SelectedCardID", "", new { @class = "text-danger" })
                    <small class="form-text text-muted">
                        Need a different card?
                        <a asp-controller="Account" asp-action="AddCard">Add a new card</a> or
                        <a asp-controller="Account" asp-action="Index">manage saved cards</a>.
                    </small>
                </div>

                <div class="form-group mt-3">
                    <label for="CouponCode">Coupon Code (optional)</label>
                    <input type="text"
                           id="CouponCode"
                           name="CouponCode"
                           class="form-control"
                           placeholder="Enter coupon code if you have one" />
                    @Html.ValidationMessage("CouponCode", "", new { @class = "text-danger" })
                </div>

                <div class="form-group mb-3">
                    <h5>Shipping To</h5>
                    @if (Model.Customer != null)
                    {
                        <p>
                            @Model.Customer.FirstName @Model.Customer.LastName<br />
                            @Model.Customer.Address<br />
                            @Model.Customer.City, @Model.Customer.State @Model.Customer.ZipCode
                        </p>
                    }
                    else
                    {
                        <p class="text-warning">
                            We could not load your profile information. Please verify your account details.
                        </p>
                    }
                    <small class="form-text text-muted">
                        Orders are shipped to the address in your profile.
                        To change it, go to
                        <a asp-controller="Account" asp-action="Modify">Manage Account</a>
                        before placing your order.
                    </small>
                </div>

                <button type="submit"
                        name="submitAction"
                        value="apply"
                        class="btn btn-outline-primary me-2">
                    Apply Coupon
                </button>

                <button type="submit"
                        name="submitAction"
                        value="place"
                        class="btn btn-success">
                    Place Order
                </button>

                <a asp-controller="OrderDetails" asp-action="Index"
                   class="btn btn-secondary mt-3">
                    Back to Cart
                </a>
            }
        </div>
        
       <!-- RIGHT: Order Summary -->
    <div class="col-md-7">
        <h3>Order Summary</h3>
        <hr />

        @if (Model.OrderDetails == null || !Model.OrderDetails.Any())
        {
            <p>Your cart is currently empty.</p>
        }
        else
        {
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Book</th>
                        <th class="text-center">Qty</th>
                        <th class="text-end">Price</th>
                        <th class="text-end">Extended</th>
                    </tr>
                </thead>
                <tbody>
                @foreach (var item in Model.OrderDetails)
                {
                    <tr>
                        <td>@item.Book.Title</td>
                        <td class="text-center">@item.Quantity</td>
                        <td class="text-end">@item.Price.ToString("C")</td>
                        <td class="text-end">@((item.Price * item.Quantity).ToString("C"))</td>
                    </tr>
                }
                </tbody>
            </table>


                <div class="row">
                    <div class="col-6 text-end">
                        <p>Subtotal:</p>
                        <p>Shipping Fee:</p>
                        @if (Model.DiscountAmount > 0)
                        {
                            <p>Discount:</p>
                        }
                        <p><strong>Estimated Total:</strong></p>
                    </div>
                    <div class="col-6 text-end">
                        <p>@String.Format("{0:C}", Model.Subtotal)</p>
                        <p>@String.Format("{0:C}", Model.ShippingFee)</p>
                        @if (Model.DiscountAmount > 0)
                        {
                            <p class="text-success">
                                -@String.Format("{0:C}", Model.DiscountAmount)
                            </p>
                        }
                        <p>
                            <strong>
                                @String.Format("{0:C}", Model.OrderTotal)
                    </strong>
                </p>
            </div>
        </div>


        @if (Model.DiscountAmount > 0)
                {
                    <p class="text-success mt-2">
                        Coupon applied – you saved
                        @String.Format("{0:C}", Model.DiscountAmount)
                        on this order.
                    </p>
                }

                <small class="text-muted">
                    Shipping is $3.50 for the first book and $1.50 for each additional book.
                </small>

            }
        </div>
    </div>
}